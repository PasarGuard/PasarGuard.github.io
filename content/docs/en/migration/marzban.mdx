---
title: Marzban to PasarGuard
icon: ArrowRightLeft
---

<Alert type="warning">
This guide is for Marzban versions `beta-3` and below.
</Alert>

This guide will help you migrate your data, settings, and user accounts from Marzban to PasarGuard without losing anything.

## Prerequisites

> ‚ö†Ô∏è **Important**: Always have a complete backup of your data before starting the migration process.

- Make sure you have root access to your server.
- Have a backup of your current Marzban installation.
- Check that Docker and Docker Compose are installed.

## Migration Steps

### 1. Stop Marzban Services

First, stop all running Marzban containers:

#### Stop Service Commands

```bash
cd /opt/marzban
docker compose down
```

### 2. Rename Main Directory

Delete the PasarGuard directories, if they already exist:

#### Directories Delete Command

```bash
rm -r /opt/pasarguard /var/lib/pasarguard /var/lib/mysql/pasarguard
```

Change the main Marzban directory name to PasarGuard:

#### Directory Rename Command

```bash
sudo mv /opt/marzban /opt/pasarguard
```

### 3. Rename Data Directory

Change the data directory name as well:

#### Data Directory Rename Command

```bash
sudo mv /var/lib/marzban /var/lib/pasarguard
```

### 4. Rename MySQL Directory (if using)

If you're using MySQL and have a dedicated directory for Marzban database:

#### MySQL Directory Rename Command

```bash
sudo mv /var/lib/mysql/marzban /var/lib/mysql/pasarguard
```

<Alert type="info">
If you encounter a "No such file or directory" error, it may be because the MySQL directory is different. Use this command instead:
```bash
mkdir -p /var/lib/mysql/pasarguard
mv /var/lib/pasarguard/mysql/* /var/lib/mysql/pasarguard
rm -r /var/lib/pasarguard/mysql
```
</Alert>

### 5. Update Environment Variables

Go to the new PasarGuard directory and update the environment file:

```bash
cd /opt/pasarguard
```

Update all paths referenced in the `.env` file with a simple command:

```bash
sudo sed -i 's|/var/lib/marzban|/var/lib/pasarguard|g' .env
```

<Alert type="warning">
If you're using an older version (0.8.4 or below), you also need to change the SQL driver:
</Alert>

```bash
nano .env
```

<Tabs items={['SQLite', 'MySQL']}>
  <Tab value="SQLite">
    ### SQLite Driver Update

    ‚ùå Old
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite:///db.sqlite3"
    ```
    ‚úÖ New
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///db.sqlite3"
    ```
  </Tab>
  <Tab value="MySQL">
    ### MySQL Driver Update

    ‚ùå Old
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://root:MYSQL_ROOT_PASSWORD@127.0.0.1/marzban"
    ```
    ‚úÖ New
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+asyncmy://root:MYSQL_ROOT_PASSWORD@127.0.0.1/pasarguard"
    ```
  </Tab>
</Tabs>

### 6. Update Docker Compose File

Update the `docker-compose.yml` file to reflect the new paths. You need to manually edit this file:

```bash
sudo nano docker-compose.yml
```

#### Docker Compose Changes

Here's a comparison showing the necessary changes:

<div className="grid md:grid-cols-2 gap-4">

<div className="space-y-2">

**‚ùå Before (Marzban)**
```yaml
services:
  marzban:
    image: gozargah/marzban:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/marzban:/var/lib/marzban
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/marzban:/var/lib/mysql
```

</div>

<div className="space-y-2">

**‚úÖ After (PasarGuard)**
```yaml
services:
  pasarguard:
    image: pasarguard/panel:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/pasarguard:/var/lib/pasarguard
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: pasarguard
    volumes:
      - /var/lib/mysql/pasarguard:/var/lib/mysql
```

</div>

</div>

#### Key Changes Summary:

<div className="overflow-x-auto">
<table>
<thead>
<tr>
<th>Section</th>
<th>Before</th>
<th>After</th>
</tr>
</thead>
<tbody>
<tr>
<td data-label="Section"><strong>Service Name</strong></td>
<td data-label="Before"><code>marzban</code></td>
<td data-label="After"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="Section"><strong>Docker Image</strong></td>
<td data-label="Before"><code>gozargah/marzban:latest</code></td>
<td data-label="After"><code>pasarguard/panel:latest</code></td>
</tr>
<tr>
<td data-label="Section"><strong>App Volume</strong></td>
<td data-label="Before"><code>/var/lib/marzban:/var/lib/marzban</code></td>
<td data-label="After"><code>/var/lib/pasarguard:/var/lib/pasarguard</code></td>
</tr>
<tr>
<td data-label="Section"><strong>MySQL Database</strong></td>
<td data-label="Before"><code>marzban</code></td>
<td data-label="After"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="Section"><strong>MySQL Volume</strong></td>
<td data-label="Before"><code>/var/lib/mysql/marzban:/var/lib/mysql</code></td>
<td data-label="After"><code>/var/lib/mysql/pasarguard:/var/lib/mysql</code></td>
</tr>
</tbody>
</table>
</div>

<Alert type="info">
Obviously, if you are using SQLite database, you should not add MySQL lines to your file. Just compare the example with your file and apply the changes.
</Alert>

### 7. Change Marzban MySQL Database to PasarGuard (if using)

If you're using SQLite database, skip this step. 
If you're using MySQL database, export the Marzban database so it can later be imported as the PasarGuard database.

#### Export Marzban Database Commands

#### Run Mysql

```bash
cd /opt/pasarguard && docker compose up -d mysql
```

#### Dump Database
You will be asked to enter the database password. Use the value of `MYSQL_ROOT_PASSWORD` found in your `.env` file.

```bash
docker compose exec mysql mysqldump -u root -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```

<Alert type="info">
If you encounter an "Access Denied" error, try using `marzban` user with `MYSQL_PASSWORD` value from your `.env` file:
```bash
docker compose exec mysql mysqldump -u marzban -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```
</Alert>

#### Edit Database Information

This step is crucial to ensure that the pasarguard database is created in MySQL.
The following command will replace "marzban" with "pasarguard" in two important lines:

```bash
sed -i '/^CREATE DATABASE/s/marzban/pasarguard/;/^USE/s/marzban/pasarguard/' /opt/pasarguard/pasarguard.sql
```

#### Import PasarGuard Database

To import the new database, replace the database password in this command with the `MYSQL_ROOT_PASSWORD` value from your `.env` file:

```bash
docker compose exec -T mysql mysql -u root -p"MYSQL_ROOT_PASSWORD" -h 127.0.0.1 < "/opt/pasarguard/pasarguard.sql"
```

Alternative Method:
You can import the database using `phpmyadmin`. Add the `phpmyadmin` service to your Docker Compose file and restart.
Edit your marzban.sql backup file in a text editor, and replace `marzban` with `pasarguard` in the beginning lines (`CREATE DATABASE` and `USE` lines).
Save the file and finally import it using `phpmyadmin`.

#### Drop Marzban Database

You will be asked to enter the database password. Use `MYSQL_ROOT_PASSWORD` value in your `.env` file.

<Alert type="warning">
Make sure you have a backup of your data and be prepared to restore the data if something goes wrong.
</Alert>

```bash
rm /opt/pasarguard/pasarguard.sql
docker compose exec mysql mysql -u root -p -e "DROP DATABASE marzban;"
```

### 8. Install PasarGuard Management Script

Install the PasarGuard management script for easier management:

#### Script Installation Command

```bash
sudo bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pasarguard.sh)" @ install-script
```

This script provides useful commands for managing your PasarGuard installation.

### 9. Start PasarGuard

Now start PasarGuard with the new configuration:

#### Startup Command

```bash
pasarguard restart
```

### 10. Verify Migration

Check that all services are running properly:

#### Verification Commands

```bash
pasarguard status
```

Open your panel URL to make sure everything is working correctly.

## Troubleshooting

### Common Issues

> üí° **Tip**: Most issues can be resolved by checking file permissions and path configurations.

**1. Permission Denied**
Make sure you're running commands with appropriate permissions (sudo when needed).

**2. Database Connection Issues**
If you're using MySQL, check that database paths and login information are properly updated.

**3. Port Conflicts**
Make sure no other services are using the same ports.

**4. Missing Environment Variables**
Double-check that all environment variables in the `.env` file are properly updated.

### Rollback

> ‚ö†Ô∏è **Emergency Rollback**: If you encounter serious issues and need to revert to the previous version

```bash
# Stop PasarGuard
cd /opt/pasarguard
docker compose down

# Restore original directories
sudo mv /opt/pasarguard /opt/marzban
sudo mv /var/lib/pasarguard /var/lib/marzban
sudo mv /var/lib/mysql/pasarguard /var/lib/mysql/marzban  # if using

# Restore original docker-compose.yml and .env files from backup
# Then start Marzban
marzban up
```

## Post-Migration

After successful migration:

- **üìä Update Monitoring**: If you have monitoring tools, connect them to the new paths.
- **üíæ Update Backups**: Make sure your backup scripts are updated to backup from the new directories.
- **üß™ Test All Features**: Thoroughly test all panel features to ensure everything is working correctly.

## Support

üîó **Links**

- **Discussion Group**: [Telegram](https://t.me/PasarGuardGP)
- **Issues**: If you encounter any problems during migration, create an issue.

---

> **üìù Note**: This guide assumes a standard Marzban installation. Custom configurations may require additional steps.
