---
title: Marzban به پاسارگارد
icon: ArrowRightLeft
---

<Alert type="warning">
این راهنما برای نسخه‌های `beta-3` و پایین‌تر Marzban هست.
</Alert>

این راهنما بهتون کمک می‌کنه تا اطلاعات، تنظیمات و اکانت‌های کاربریتون رو از Marzban به پاسارگارد منتقل کنید، بدون اینکه چیزی از دست بره.

## پیش‌نیازها

> ⚠️ **مهم**: همیشه قبل از شروع فرآیند مهاجرت، یه بک‌آپ کامل از اطلاعاتتون داشته باشید.

- مطمئن شید که به سرورتون دسترسی root دارید.
- یه بک‌آپ از نصب فعلی Marzban داشته باشید.
- چک کنید که Docker و Docker Compose نصب باشن.

## مراحل مهاجرت

### 1. سرویس‌های Marzban رو متوقف کنید

اول از همه، همه کانتینرهای در حال اجرای Marzban رو متوقف کنید:

#### دستورات توقف سرویس

```bash
cd /opt/marzban
docker compose down
```

### 2. اسم پوشه اصلی رو عوض کنید

اگر پوشه‌های پاسارگارد از قبل وجود دارند، آنها را حذف کنید:

#### دستور حذف پوشه‌ها

```bash
rm -r /opt/pasarguard /var/lib/pasarguard /var/lib/mysql/pasarguard
```

اسم پوشه اصلی Marzban رو به PasarGuard تغییر بدید:

#### دستور تغییر نام پوشه

```bash
sudo mv /opt/marzban /opt/pasarguard
```

### 3. اسم پوشه دیتا رو عوض کنید

اسم پوشه دیتا رو هم تغییر بدید:

#### دستور تغییر نام پوشه دیتا

```bash
sudo mv /var/lib/marzban /var/lib/pasarguard
```

### 4. اسم پوشه MySQL رو عوض کنید (اگه استفاده می‌کنید)

اگه از MySQL استفاده می‌کنید و یه پوشه اختصاصی برای دیتابیس Marzban دارید:

#### دستور تغییر نام پوشه MySQL

```bash
sudo mv /var/lib/mysql/marzban /var/lib/mysql/pasarguard
```

<Alert type="info">
اگر با خطای «فایل یا پوشه وجود ندارد» مواجه شدید، ممکن است پوشه MySQL متفاوت باشد. در این صورت از این دستور استفاده کنید:
```bash
mkdir -p /var/lib/mysql/pasarguard
mv /var/lib/pasarguard/mysql/* /var/lib/mysql/pasarguard
rm -r /var/lib/pasarguard/mysql
```
</Alert>

### 5. متغیرهای محیطی رو به‌روز کنید

برید به پوشه جدید PasarGuard و فایل محیطی رو به‌روز کنید:

```bash
cd /opt/pasarguard
```

همه مسیرهای اشاره شده تو فایل `.env` رو با یه دستور ساده به‌روز کنید:

```bash
sudo sed -i 's|/var/lib/marzban|/var/lib/pasarguard|g' .env
```

<Alert type="warning">
اگه از نسخه قدیمی (0.8.4 یا پایین‌تر) استفاده می‌کنید، باید درایور SQL رو هم تغییر بدید:
</Alert>

```bash
nano .env
```

<Tabs items={['SQLite', 'MySQL']}>
  <Tab value="SQLite">
    ### به‌روزرسانی درایور SQLite

    ❌ قدیمی
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite:///db.sqlite3"
    ```
    ✅ جدید
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///db.sqlite3"
    ```
  </Tab>
  <Tab value="MySQL">
    ### به‌روزرسانی درایور MySQL

    ❌ قدیمی
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://root:MYSQL_ROOT_PASSWORD@127.0.0.1/marzban"
    ```
    ✅ جدید
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+asyncmy://root:MYSQL_ROOT_PASSWORD@127.0.0.1/pasarguard"
    ```
  </Tab>
</Tabs>

### 6. فایل Docker Compose رو به‌روز کنید

فایل `docker-compose.yml` رو برای نشون دادن مسیرهای جدید به‌روز کنید. باید این فایل رو دستی ویرایش کنید:

```bash
sudo nano docker-compose.yml
```

#### تغییرات Docker Compose

اینجا یه مقایسه هست که تغییرات لازم رو نشون میده:

<div className="grid md:grid-cols-2 gap-4">

<div className="space-y-2">

**❌ قبل (Marzban)**
```yaml
services:
  marzban:
    image: gozargah/marzban:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/marzban:/var/lib/marzban
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/marzban:/var/lib/mysql
```

</div>

<div className="space-y-2">

**✅ بعد (PasarGuard)**
```yaml
services:
  pasarguard:
    image: pasarguard/panel:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/pasarguard:/var/lib/pasarguard
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: pasarguard
    volumes:
      - /var/lib/mysql/pasarguard:/var/lib/mysql
```

</div>

</div>

#### خلاصه تغییرات کلیدی:

<div className="overflow-x-auto">
<table>
<thead>
<tr>
<th>بخش</th>
<th>قبل</th>
<th>بعد</th>
</tr>
</thead>
<tbody>
<tr>
<td data-label="بخش"><strong>اسم سرویس</strong></td>
<td data-label="قبل"><code>marzban</code></td>
<td data-label="بعد"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>ایمیج Docker</strong></td>
<td data-label="قبل"><code>gozargah/marzban:latest</code></td>
<td data-label="بعد"><code>pasarguard/panel:latest</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>ولوم برنامه</strong></td>
<td data-label="قبل"><code>/var/lib/marzban:/var/lib/marzban</code></td>
<td data-label="بعد"><code>/var/lib/pasarguard:/var/lib/pasarguard</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>دیتابیس MySQL</strong></td>
<td data-label="قبل"><code>marzban</code></td>
<td data-label="بعد"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="بخش"><strong>ولوم MySQL</strong></td>
<td data-label="قبل"><code>/var/lib/mysql/marzban:/var/lib/mysql</code></td>
<td data-label="بعد"><code>/var/lib/mysql/pasarguard:/var/lib/mysql</code></td>
</tr>
</tbody>
</table>
</div>

<Alert type="info">
بدیهی هست که اگر از دیتابیس SQLite استفاده می‌کنید، نباید خطوط مربوط به MySQL رو به فایل خودتون اضافه کنید. فقط نمونه رو با فایل خودتون مقایسه کنید و تغییرات رو اعمال کنید.
</Alert>

### 7. تغییر دیتابیس MySQL مرزبان به پاسارگارد (در صورت استفاده)

اگر از دیتابیس SQLite استفاده می‌کنید، این مرحله رو رد کنید.
اما اگر از MySQL استفاده می‌کنید، باید دیتابیس مرزبان رو خروجی بگیرید تا بعداً به عنوان دیتابیس PasarGuard وارد بشه.

#### گرفتن خروجی از دیتابیس مرزبان

#### اجرای MySQL

```bash
cd /opt/pasarguard && docker compose up -d mysql
```

#### گرفتن Dump از دیتابیس
در این مرحله ازتون پسورد دیتابیس خواسته میشه. همون مقدار `MYSQL_ROOT_PASSWORD` که داخل فایل `.env` هست رو وارد کنید:
```bash
docker compose exec mysql mysqldump -u root -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```

<Alert type="info">
اگر با خطای "Access Denied" روبه‌رو شدید، به جای یوزر `root` از یوزر `marzban` به همراه پسورد `MYSQL_PASSWORD` داخل `.env` استفاده کنید:
```bash
docker compose exec mysql mysqldump -u marzban -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```
</Alert>

#### ویرایش اطلاعات دیتابیس

این مرحله خیلی مهمه چون باید دیتابیس pasarguard داخل MySQL ساخته بشه.
با دستور زیر اسم "marzban" به "pasarguard" توی دو خط مهم (`CREATE DATABASE` و `USE`) تغییر داده میشه:

```bash
sed -i '/^CREATE DATABASE/s/marzban/pasarguard/;/^USE/s/marzban/pasarguard/' /opt/pasarguard/pasarguard.sql
```

#### وارد کردن دیتابیس پاسارگارد

برای وارد کردن دیتابیس جدید، مقدار `MYSQL_ROOT_PASSWORD` که داخل `.env` هست رو در دستور زیر جایگزین کنید و اجرا کنید:

```bash
docker compose exec -T mysql mysql -u root -p"MYSQL_ROOT_PASSWORD" -h 127.0.0.1 < "/opt/pasarguard/pasarguard.sql"
```

روش جایگزین: می‌تونید با `phpMyAdmin` هم دیتابیس رو وارد کنید.
سرویس `phpMyAdmin` رو به فایل Docker Compose اضافه کنید و ری‌استارت کنید.
فایل بکاپ `marzban.sql` رو با یک ویرایشگر متن باز کنید.
اسم `marzban` رو در ابتدای فایل (خط‌های `CREATE DATABASE` و `USE`) به `pasarguard` تغییر بدید.
فایل رو ذخیره کنید و از طریق `phpMyAdmin` ایمپورت کنید.

#### حذف دیتابیس مرزبان

برای حذف دیتابیس مرزبان، دستور زیر رو اجرا کنید و دوباره پسورد رو وارد کنید (مقدار `MYSQL_ROOT_PASSWORD` داخل `.env`):

<Alert type="warning">
حتماً قبل از حذف، بکاپ داشته باشید و آماده باشید در صورت مشکل بتونید دیتا رو برگردونید.
</Alert>

```bash
rm /opt/pasarguard/pasarguard.sql
docker compose exec mysql mysql -u root -p -e "DROP DATABASE marzban;"
```

### 8. اسکریپت مدیریت پاسارگارد رو نصب کنید

اسکریپت مدیریت پاسارگارد رو برای مدیریت راحت‌تر نصب کنید:

#### دستور نصب اسکریپت

```bash
sudo bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pasarguard.sh)" @ install-script
```

این اسکریپت دستورات کاربردی برای مدیریت نصب پاسارگارد بهتون میده.

### 9. پاسارگارد رو راه‌اندازی کنید

حالا پاسارگارد رو با تنظیمات جدید راه‌اندازی کنید:

#### دستور راه‌اندازی

```bash
pasarguard restart
```

### 10. مهاجرت رو بررسی کنید

چک کنید که همه سرویس‌ها درست کار می‌کنن:

#### دستورات بررسی

```bash
pasarguard status
```

آدرس پنلتون رو باز کنید تا مطمئن شید همه چی اوکیه.

## عیب‌یابی

### مشکلات رایج

> 💡 **نکته**: بیشتر مشکلات با بررسی دسترسی‌های فایل و تنظیمات مسیرها حل میشن.

**1. اجازه دسترسی ندارید (Permission Denied)**
مطمئن شید که دستورات رو با دسترسی‌های مناسب (sudo در صورت نیاز) اجرا می‌کنید.

**2. مشکلات اتصال به دیتابیس**
اگه از MySQL استفاده می‌کنید، چک کنید که مسیرهای دیتابیس و اطلاعات ورود درست به‌روز شده باشن.

**3. تداخل پورت‌ها**
مطمئن شید که هیچ سرویس دیگه‌ای از همون پورت‌ها استفاده نمی‌کنه.

**4. متغیرهای محیطی گم شده**
دوباره چک کنید که همه متغیرهای محیطی تو فایل `.env` درست به‌روز شده باشن.

### برگشت به نسخه قبل

> ⚠️ **بازگشت اضطراری**: اگه با مشکلات جدی مواجه شدید و نیاز به بازگشت به نسخه قبل دارید

```bash
# پاسارگارد رو متوقف کنید
cd /opt/pasarguard
docker compose down

# پوشه‌های اصلی رو برگردونید
sudo mv /opt/pasarguard /opt/marzban
sudo mv /var/lib/pasarguard /var/lib/marzban
sudo mv /var/lib/mysql/pasarguard /var/lib/mysql/marzban  # اگه استفاده می‌کنید

# فایل‌های docker-compose.yml و .env اصلی رو از بک‌آپ برگردونید
# بعد Marzban رو راه‌اندازی کنید
marzban up
```

## بعد از مهاجرت

بعد از مهاجرت موفق:

- **📊 مانیتورینگ رو به‌روز کنید**: اگه ابزارهای مانیتورینگ دارید، اون‌ها رو به مسیرهای جدید متصل کنید.
- **💾 بک‌آپ‌ها رو به‌روز کنید**: مطمئن شید که اسکریپت‌های بک‌آپتون برای بک‌آپ گرفتن از پوشه‌های جدید به‌روز شدن.
- **🧪 همه قابلیت‌ها رو تست کنید**: همه قابلیت‌های پنل رو کامل تست کنید تا مطمئن شید همه چی درست کار می‌کنه.

## پشتیبانی

🔗 **لینک‌ها**

- **گروه بحث و گفتگو**: [Telegram](https://t.me/PasarGuardGP)
- **مشکلات**: اگه تو طول مهاجرت به مشکلی برخوردید، یه issue بسازید.

---

> **📝 نکته**: این راهنما فرض رو بر این میذاره که نصب Marzban استاندارد بوده. تنظیمات شخصی ممکنه نیاز به مراحل اضافی داشته باشن.
