---
title: Marzban к PasarGuard
icon: ArrowRightLeft
---

<Alert type="warning">
Это руководство для версий Marzban `beta-3` и ниже.
</Alert>

Это руководство поможет вам перенести ваши данные, настройки и пользовательские аккаунты из Marzban в PasarGuard без потери информации.

## Предварительные требования

> ⚠️ **Важно**: Всегда создавайте полную резервную копию ваших данных перед началом процесса миграции.

- Убедитесь, что у вас есть root-доступ к серверу.
- Создайте резервную копию текущей установки Marzban.
- Проверьте, что установлены Docker и Docker Compose.

## Шаги миграции

### 1. Остановите сервисы Marzban

Сначала остановите все запущенные контейнеры Marzban:

#### Команды остановки сервиса

```bash
cd /opt/marzban
docker compose down
```

### 2. Переименуйте основную директорию

Удалите каталоги PasarGuard, если они уже существуют:

#### Команда удаления каталогов

```bash
rm -r /opt/pasarguard /var/lib/pasarguard /var/lib/mysql/pasarguard
```

Измените название основной директории Marzban на PasarGuard:

#### Команда переименования директории

```bash
sudo mv /opt/marzban /opt/pasarguard
```

### 3. Переименуйте директорию данных

Также измените название директории данных:

#### Команда переименования директории данных

```bash
sudo mv /var/lib/marzban /var/lib/pasarguard
```

### 4. Переименуйте директорию MySQL (если используется)

Если вы используете MySQL и у вас есть выделенная директория для базы данных Marzban:

#### Команда переименования директории MySQL

```bash
sudo mv /var/lib/mysql/marzban /var/lib/mysql/pasarguard
```

<Alert type="info">
Если вы столкнулись с ошибкой «Нет такого файла или каталога», это может быть связано с тем, что каталог MySQL отличается. Вместо этого используйте следующую команду:
```bash
mkdir -p /var/lib/mysql/pasarguard
mv /var/lib/pasarguard/mysql/* /var/lib/mysql/pasarguard
rm -r /var/lib/pasarguard/mysql
```
</Alert>

### 5. Обновите переменные окружения

Перейдите в новую директорию PasarGuard и обновите файл окружения:

```bash
cd /opt/pasarguard
```

Обновите все пути, указанные в файле `.env`, простой командой:

```bash
sudo sed -i 's|/var/lib/marzban|/var/lib/pasarguard|g' .env
```

<Alert type="warning">
Если вы используете старую версию (0.8.4 или ниже), вам также нужно изменить SQL-драйвер:
</Alert>

```bash
nano .env
```

<Tabs items={['SQLite', 'MySQL']}>
  <Tab value="SQLite">
    ### Обновление драйвера SQLite

    ❌ Старый
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite:///db.sqlite3"
    ```
    ✅ Новый
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///db.sqlite3"
    ```
  </Tab>
  <Tab value="MySQL">
    ### Обновление драйвера MySQL

    ❌ Старый
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://root:DB_PASSWORD@127.0.0.1/marzban"
    ```
    ✅ Новый
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+asyncmy://root:DB_PASSWORD@127.0.0.1/pasarguard"
    ```
  </Tab>
</Tabs>

### 6. Обновите файл Docker Compose

Обновите файл `docker-compose.yml` для отражения новых путей. Вам нужно вручную отредактировать этот файл:

```bash
sudo nano docker-compose.yml
```

#### Изменения Docker Compose

Вот сравнение, показывающее необходимые изменения:

<div className="grid md:grid-cols-2 gap-4">

<div className="space-y-2">

**❌ До (Marzban)**
```yaml
services:
  marzban:
    image: gozargah/marzban:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/marzban:/var/lib/marzban
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/marzban:/var/lib/mysql
```

</div>

<div className="space-y-2">

**✅ После (PasarGuard)**
```yaml
services:
  pasarguard:
    image: pasarguard/panel:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/pasarguard:/var/lib/pasarguard
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: pasarguard
    volumes:
      - /var/lib/mysql/pasarguard:/var/lib/mysql
```

</div>

</div>

#### Сводка ключевых изменений:

<div className="overflow-x-auto">
<table>
<thead>
<tr>
<th>Секция</th>
<th>До</th>
<th>После</th>
</tr>
</thead>
<tbody>
<tr>
<td data-label="Секция"><strong>Имя сервиса</strong></td>
<td data-label="До"><code>marzban</code></td>
<td data-label="После"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="Секция"><strong>Docker образ</strong></td>
<td data-label="До"><code>gozargah/marzban:latest</code></td>
<td data-label="После"><code>pasarguard/panel:latest</code></td>
</tr>
<tr>
<td data-label="Секция"><strong>Том приложения</strong></td>
<td data-label="До"><code>/var/lib/marzban:/var/lib/marzban</code></td>
<td data-label="После"><code>/var/lib/pasarguard:/var/lib/pasarguard</code></td>
</tr>
<tr>
<td data-label="Раздел"><strong>База данных MySQL</strong></td>
<td data-label="До"><code>marzban</code></td>
<td data-label="После"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="Раздел"><strong>Том MySQL</strong></td>
<td data-label="До"><code>/var/lib/mysql/marzban:/var/lib/mysql</code></td>
<td data-label="После"><code>/var/lib/mysql/pasarguard:/var/lib/mysql</code></td>
</tr>
</tbody>
</table>
</div>

<Alert type="info">
Очевидно, если вы используете базу данных SQLite, вам не следует добавлять строки MySQL в свой файл. Просто сравните пример со своим файлом и примените изменения.
</Alert>

### 7. Измените базу данных Marzban MySQL на PasarGuard (если используется).

Если вы используете базу данных SQLite, пропустите этот шаг.

Если вы используете базу данных MySQL, экспортируйте базу данных Marzban, чтобы её можно было позже импортировать как базу данных PasarGuard.

#### Команды экспорта базы данных Marzban

#### Запуск MySQL

```bash
cd /opt/pasarguard && docker compose up -d mysql
```

#### Вывод базы данных
Вам будет предложено ввести пароль базы данных. Используйте значение `MYSQL_ROOT_PASSWORD` из файла `.env`.

```bash
docker compose exec mysql mysqldump -u root -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```

<Alert type="info">
Если вы столкнулись с ошибкой «Отказано в доступе», попробуйте использовать пользователя `marzban` со значением `MYSQL_PASSWORD` из файла `.env`:
```bash
docker compose exec mysql mysqldump -u marzban -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```
</Alert>

#### Изменение информации о базе данных

Этот шаг крайне важен для создания базы данных pasarguard в MySQL.
Следующая команда заменит «marzban» на «pasarguard» в двух важных строках:

```bash
sed -i '/^CREATE DATABASE/s/marzban/pasarguard/;/^USE/s/marzban/pasarguard/' /opt/pasarguard/pasarguard.sql
```

#### Импорт базы данных PasarGuard

Чтобы импортировать новую базу данных, замените пароль базы данных в этой команде на значение `MYSQL_ROOT_PASSWORD` из файла `.env`:

```bash
docker compose exec -T mysql mysql -u root -p"MYSQL_ROOT_PASSWORD" -h 127.0.0.1 < "/opt/pasarguard/pasarguard.sql"
```

Альтернативный метод:
Вы можете импортировать базу данных с помощью `phpmyadmin`. Добавьте службу `phpmyadmin` в файл Docker Compose и перезапустите его.
Отредактируйте файл резервной копии marzban.sql в текстовом редакторе, заменив `marzban` на `pasarguard` в начальных строках (строки `CREATE DATABASE` и `USE`).

Сохраните файл и импортируйте его с помощью `phpmyadmin`.

#### Удаление базы данных Marzban

Вам будет предложено ввести пароль базы данных. Используйте значение `MYSQL_ROOT_PASSWORD` из файла `.env`.

<Alert type="warning">
Убедитесь, что у вас есть резервная копия данных, и будьте готовы восстановить их в случае возникновения проблем.
</Alert>

```bash
rm /opt/pasarguard/pasarguard.sql
docker compose exec mysql mysql -u root -p -e "DROP DATABASE marzban;"
```

### 8. Установите скрипт управления PasarGuard

Установите скрипт управления PasarGuard для более удобного управления:

#### Команда установки скрипта

```bash
sudo bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pasarguard.sh)" @ install-script
```

Этот скрипт предоставляет полезные команды для управления вашей установкой PasarGuard.

### 9. Запустите PasarGuard

Теперь запустите PasarGuard с новой конфигурацией:

#### Команда запуска

```bash
pasarguard restart
```

### 10. Проверьте миграцию

Проверьте, что все сервисы работают правильно:

#### Команды проверки

```bash
pasarguard status
```

Откройте URL вашей панели, чтобы убедиться, что все работает корректно.

## Устранение неполадок

### Распространенные проблемы

> 💡 **Совет**: Большинство проблем можно решить, проверив права доступа к файлам и конфигурацию путей.

**1. Отказано в доступе (Permission Denied)**
Убедитесь, что вы запускаете команды с соответствующими правами (sudo при необходимости).

**2. Проблемы с подключением к базе данных**
Если вы используете MySQL, проверьте, что пути к базе данных и данные для входа правильно обновлены.

**3. Конфликты портов**
Убедитесь, что никакие другие сервисы не используют те же порты.

**4. Отсутствующие переменные окружения**
Дважды проверьте, что все переменные окружения в файле `.env` правильно обновлены.

### Откат

> ⚠️ **Экстренный откат**: Если вы столкнулись с серьезными проблемами и вам нужно вернуться к предыдущей версии

```bash
# Остановите PasarGuard
cd /opt/pasarguard
docker compose down

# Восстановите оригинальные директории
sudo mv /opt/pasarguard /opt/marzban
sudo mv /var/lib/pasarguard /var/lib/marzban
sudo mv /var/lib/mysql/pasarguard /var/lib/mysql/marzban  # если используется

# Восстановите оригинальные файлы docker-compose.yml и .env из резервной копии
# Затем запустите Marzban
marzban up
```

## После миграции

После успешной миграции:

- **📊 Обновите мониторинг**: Если у вас есть инструменты мониторинга, подключите их к новым путям.
- **💾 Обновите резервные копии**: Убедитесь, что ваши скрипты резервного копирования обновлены для резервного копирования из новых директорий.
- **🧪 Протестируйте все функции**: Тщательно протестируйте все функции панели, чтобы убедиться, что все работает правильно.

## Поддержка

🔗 **Ссылки**

- **Группа обсуждений**: [Telegram](https://t.me/PasarGuardGP)
- **Проблемы**: Если вы столкнулись с проблемами во время миграции, создайте issue.

---

> **📝 Примечание**: Это руководство предполагает стандартную установку Marzban. Пользовательские конфигурации могут потребовать дополнительных шагов.
