---
title: Marzban 到 PasarGuard
icon: ArrowRightLeft
---

<Alert type="warning">
此指南适用于 Marzban 版本 `beta-3` 及以下。
</Alert>

此指南将帮助您将数据、设置和用户账户从 Marzban 迁移到 PasarGuard，而不会丢失任何内容。

## 先决条件

> ⚠️ **重要**: 在开始迁移过程之前，请始终备份您的完整数据。

- 确保您对服务器具有 root 访问权限。
- 备份您当前的 Marzban 安装。
- 检查是否安装了 Docker 和 Docker Compose。

## 迁移步骤

### 1. 停止 Marzban 服务

首先，停止所有正在运行的 Marzban 容器：

#### 停止服务命令

```bash
cd /opt/marzban
docker compose down
```

### 2. 重命名主目录

如果 PasarGuard 目录已存在，请删除它们：

#### 目录删除命令

```bash
rm -r /opt/pasarguard /var/lib/pasarguard /var/lib/mysql/pasarguard
```

将 Marzban 主目录名称更改为 PasarGuard：

#### 目录重命名命令

```bash
sudo mv /opt/marzban /opt/pasarguard
```

### 3. 重命名数据目录

同时更改数据目录名称：

#### 数据目录重命名命令

```bash
sudo mv /var/lib/marzban /var/lib/pasarguard
```

### 4. 重命名 MySQL 目录（如果使用）

如果您使用 MySQL 并且有 Marzban 数据库的专用目录：

#### MySQL 目录重命名命令

```bash
sudo mv /var/lib/mysql/marzban /var/lib/mysql/pasarguard
```

<Alert type="info">
如果您遇到“无此文件或目录”错误，可能是因为 MySQL 目录不同。请使用以下命令：
```bash
mkdir -p /var/lib/mysql/pasarguard
mv /var/lib/pasarguard/mysql/* /var/lib/mysql/pasarguard
rm -r /var/lib/pasarguard/mysql
```
</Alert>

### 5. 更新环境变量

转到新的 PasarGuard 目录并更新环境文件：

```bash
cd /opt/pasarguard
```

使用简单命令更新 `.env` 文件中引用的所有路径：

```bash
sudo sed -i 's|/var/lib/marzban|/var/lib/pasarguard|g' .env
```

<Alert type="warning">
如果您使用的是旧版本（0.8.4 或更低），还需要更改 SQL 驱动程序：
</Alert>

```bash
nano .env
```

<Tabs items={['SQLite', 'MySQL']}>
  <Tab value="SQLite">
    ### SQLite 驱动程序更新

    ❌ 旧版本
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite:///db.sqlite3"
    ```
    ✅ 新版本
    ```bash
    SQLALCHEMY_DATABASE_URL = "sqlite+aiosqlite:///db.sqlite3"
    ```
  </Tab>
  <Tab value="MySQL">
    ### MySQL 驱动程序更新

    ❌ 旧版本
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+pymysql://root:DB_PASSWORD@127.0.0.1/marzban"
    ```
    ✅ 新版本
    ```bash
    SQLALCHEMY_DATABASE_URL = "mysql+asyncmy://root:DB_PASSWORD@127.0.0.1/pasarguard"
    ```
  </Tab>
</Tabs>

### 6. 更新 Docker Compose 文件

更新 `docker-compose.yml` 文件以反映新路径。您需要手动编辑此文件：

```bash
sudo nano docker-compose.yml
```

#### Docker Compose 更改

以下是显示必要更改的比较：

<div className="grid md:grid-cols-2 gap-4">

<div className="space-y-2">

**❌ 之前 (Marzban)**
```yaml
services:
  marzban:
    image: gozargah/marzban:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/marzban:/var/lib/marzban
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: marzban
    volumes:
      - /var/lib/mysql/marzban:/var/lib/mysql
```

</div>

<div className="space-y-2">

**✅ 之后 (PasarGuard)**
```yaml
services:
  pasarguard:
    image: pasarguard/panel:latest
    restart: always
    env_file: .env
    network_mode: host
    volumes:
      - /var/lib/pasarguard:/var/lib/pasarguard
    depends_on:
      - mysql

  mysql:
    image: mysql:lts
    restart: always
    env_file: .env
    network_mode: host
    command: --bind-address=127.0.0.1 --mysqlx-bind-address=127.0.0.1 --disable-log-bin
    environment:
      MYSQL_DATABASE: pasarguard
    volumes:
      - /var/lib/mysql/pasarguard:/var/lib/mysql
```

</div>

</div>

#### 关键更改摘要：

<div className="overflow-x-auto">
<table>
<thead>
<tr>
<th>部分</th>
<th>之前</th>
<th>之后</th>
</tr>
</thead>
<tbody>
<tr>
<td data-label="部分"><strong>服务名称</strong></td>
<td data-label="之前"><code>marzban</code></td>
<td data-label="之后"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="部分"><strong>Docker 镜像</strong></td>
<td data-label="之前"><code>gozargah/marzban:latest</code></td>
<td data-label="之后"><code>pasarguard/panel:latest</code></td>
</tr>
<tr>
<td data-label="部分"><strong>应用卷</strong></td>
<td data-label="之前"><code>/var/lib/marzban:/var/lib/marzban</code></td>
<td data-label="之后"><code>/var/lib/pasarguard:/var/lib/pasarguard</code></td>
</tr>
<tr>
<td data-label="Section"><strong>MySQL 数据库</strong></td>
<td data-label="Before"><code>marzban</code></td>
<td data-label="After"><code>pasarguard</code></td>
</tr>
<tr>
<td data-label="Section"><strong>MySQL 卷</strong></td>
<td data-label="Before"><code>/var/lib/mysql/marzban:/var/lib/mysql</code></td>
<td data-label="After"><code>/var/lib/mysql/pasarguard:/var/lib/mysql</code></td>
</tr>
</tbody>
</table>
</div>

<Alert type="info">
显然，如果您使用的是 SQLite 数据库，则不应在文件中添加 MySQL 代码行。只需将示例与您的文件进行比较并应用更改即可。
</Alert>

### 7. 将 Marzban MySQL 数据库更改为 PasarGuard（如果使用）

如果您使用的是 SQLite 数据库，请跳过此步骤。
如果您使用的是 MySQL 数据库，请导出 Marzban 数据库，以便稍后将其导入为 PasarGuard 数据库。

#### 导出 Marzban 数据库命令

#### 运行 Mysql

```bash
cd /opt/pasarguard && docker compose up -d mysql
```

#### 转储数据库
系统将要求您输入数据库密码。请使用 `.env` 文件中 `MYSQL_ROOT_PASSWORD` 的值。

```bash
docker compose exec mysql mysqldump -u root -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```

<Alert type="info">
如果遇到“访问被拒绝”错误，请尝试使用 `marzban` 用户，并使用 `.env` 文件中的 `MYSQL_PASSWORD` 值：
```bash
docker compose exec mysql mysqldump -u marzban -p -h 127.0.0.1 --databases marzban > "/opt/pasarguard/pasarguard.sql"
```
</Alert>

#### 编辑数据库信息

此步骤对于确保在 MySQL 中创建 pasarguard 数据库至关重要。
以下命令将在两行重要内容中将“marzban”替换为“pasarguard”：

```bash
sed -i '/^CREATE DATABASE/s/marzban/pasarguard/;/^USE/s/marzban/pasarguard/' /opt/pasarguard/pasarguard.sql
```

#### 导入 PasarGuard 数据库

要导入新数据库，请将此命令中的数据库密码替换为“.env”文件中的“MYSQL_ROOT_PASSWORD”值：

```bash
docker compose exec -T mysql mysql -u root -p"MYSQL_ROOT_PASSWORD" -h 127.0.0.1 < "/opt/pasarguard/pasarguard.sql"
```

替代方法：
您可以使用“phpmyadmin”导入数据库。将 `phpmyadmin` 服务添加到您的 Docker Compose 文件并重启。
使用文本编辑器编辑 marzban.sql 备份文件，并在开头几行（`CREATE DATABASE` 和 `USE` 行）中将 `marzban` 替换为 `pasarguard`。
保存文件，最后使用 `phpmyadmin` 导入。

#### 删除 Marzban 数据库

系统将要求您输入数据库密码。请使用 `.env` 文件中的 `MYSQL_ROOT_PASSWORD` 值。

<Alert type="warning">
请确保您已备份数据，并准备好在出现问题时恢复数据。
</Alert>

```bash
rm /opt/pasarguard/pasarguard.sql
docker compose exec mysql mysql -u root -p -e "DROP DATABASE marzban;"
```

### 8. 安装 PasarGuard 管理脚本

安装 PasarGuard 管理脚本以便于管理：

#### 脚本安装命令

```bash
sudo bash -c "$(curl -sL https://github.com/PasarGuard/scripts/raw/main/pasarguard.sh)" @ install-script
```

此脚本为管理您的 PasarGuard 安装提供有用的命令。

### 9. 启动 PasarGuard

现在使用新配置启动 PasarGuard：

#### 启动命令

```bash
pasarguard restart
```

### 10. 验证迁移

检查所有服务是否正常运行：

#### 验证命令

```bash
pasarguard status
```

打开您的面板 URL 以确保一切正常工作。

## 故障排除

### 常见问题

> 💡 **提示**: 大多数问题可以通过检查文件权限和路径配置来解决。

**1. 权限被拒绝**
确保您使用适当的权限运行命令（需要时使用 sudo）。

**2. 数据库连接问题**
如果您使用 MySQL，请检查数据库路径和登录信息是否正确更新。

**3. 端口冲突**
确保没有其他服务使用相同的端口。

**4. 缺少环境变量**
再次检查 `.env` 文件中的所有环境变量是否正确更新。

### 回滚

> ⚠️ **紧急回滚**: 如果您遇到严重问题并需要恢复到以前版本

```bash
# 停止 PasarGuard
cd /opt/pasarguard
docker compose down

# 恢复原始目录
sudo mv /opt/pasarguard /opt/marzban
sudo mv /var/lib/pasarguard /var/lib/marzban
sudo mv /var/lib/mysql/pasarguard /var/lib/mysql/marzban  # 如果使用

# 从备份恢复原始 docker-compose.yml 和 .env 文件
# 然后启动 Marzban
marzban up
```

## 迁移后

成功迁移后：

- **📊 更新监控**: 如果您有监控工具，请将它们连接到新路径。
- **💾 更新备份**: 确保您的备份脚本已更新为从新目录进行备份。
- **🧪 测试所有功能**: 彻底测试所有面板功能以确保一切正常工作。

## 支持

🔗 **链接**

- **讨论组**: [Telegram](https://t.me/PasarGuardGP)
- **问题**: 如果您在迁移过程中遇到任何问题，请创建 issue。

---

> **📝 注意**: 此指南假设标准 Marzban 安装。自定义配置可能需要额外步骤。
